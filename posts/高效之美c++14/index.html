<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="源码解读C++14打造的高性能WebServer，轻松实现上万QPS的优化与实践。">
<title>高效之美：C&#43;&#43;14 WebServer 源码探秘</title>

<link rel='canonical' href='http://localhost:1313/posts/%E9%AB%98%E6%95%88%E4%B9%8B%E7%BE%8Ec&#43;&#43;14/'>

<link rel="stylesheet" href="/scss/style.min.e460b8d7eabe89e4f4bae506eaa6feb3eb535a19c85caa61e95db0347acaac78.css"><meta property='og:title' content="高效之美：C++14 WebServer 源码探秘">
<meta property='og:description' content="源码解读C++14打造的高性能WebServer，轻松实现上万QPS的优化与实践。">
<meta property='og:url' content='http://localhost:1313/posts/%E9%AB%98%E6%95%88%E4%B9%8B%E7%BE%8Ec&#43;&#43;14/'>
<meta property='og:site_name' content='七月流火'>
<meta property='og:type' content='article'><meta property='article:section' content='Posts' /><meta property='article:published_time' content='2024-06-22T17:34:15&#43;08:00'/><meta property='article:modified_time' content='2024-06-22T17:34:15&#43;08:00'/><meta property='og:image' content='http://localhost:1313/posts/%E9%AB%98%E6%95%88%E4%B9%8B%E7%BE%8Ec&#43;&#43;14/webserver_cover.jpg' />
<meta name="twitter:title" content="高效之美：C++14 WebServer 源码探秘">
<meta name="twitter:description" content="源码解读C++14打造的高性能WebServer，轻松实现上万QPS的优化与实践。"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='http://localhost:1313/posts/%E9%AB%98%E6%95%88%E4%B9%8B%E7%BE%8Ec&#43;&#43;14/webserver_cover.jpg' />
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "light");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu5633651980197582967.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">七月流火</a></h1>
            <h2 class="site-description">不积跬步，无已至千里; 不积小流，无以成江海。</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/qiyueliuhuo'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>首页</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E4%B8%83%E6%9C%88%E6%B5%81%E7%81%AB/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>关于</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E4%B9%A6%E6%9E%B6/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-bookshelf" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <rect x="3" y="3" width="18" height="18" rx="2" />
  <line x1="3" y1="7" x2="21" y2="7" />
  <line x1="3" y1="14" x2="21" y2="14" />
  <line x1="9" y1="7" x2="9" y2="14" />
  <line x1="15" y1="7" x2="15" y2="14" />
  <line x1="9" y1="18" x2="9" y2="21" />
  <line x1="15" y1="18" x2="15" y2="21" />
</svg>
                
                <span>书架</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>归档</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>搜索</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%8F%8B%E9%93%BE/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>友链</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>暗色模式</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#参考资料">参考资料</a></li>
    <li><a href="#前言">前言</a>
      <ol>
        <li><a href="#谁适合阅读这篇文章">谁适合阅读这篇文章？</a></li>
        <li><a href="#如何更好地阅读本篇文章">如何更好地阅读本篇文章？</a></li>
      </ol>
    </li>
    <li><a href="#项目简介">项目简介</a></li>
    <li><a href="#项目目录结构">项目目录结构</a></li>
    <li><a href="#项目启动">项目启动</a>
      <ol>
        <li><a href="#配置数据库">配置数据库</a></li>
        <li><a href="#编译运行">编译运行</a></li>
        <li><a href="#压力测试">压力测试</a></li>
      </ol>
    </li>
    <li><a href="#功能介绍">功能介绍</a></li>
    <li><a href="#时序图">时序图</a></li>
    <li><a href="#关键技术">关键技术</a>
      <ol>
        <li><a href="#io复用技术-epoll">IO复用技术 Epoll</a></li>
        <li><a href="#线程池">线程池</a>
          <ol>
            <li><a href="#简介">简介</a></li>
            <li><a href="#参考资料-1">参考资料</a></li>
            <li><a href="#代码解析">代码解析</a></li>
          </ol>
        </li>
        <li><a href="#基于小根堆实现的定时器">基于小根堆实现的定时器</a>
          <ol>
            <li><a href="#小根堆">小根堆</a></li>
            <li><a href="#源码解析">源码解析</a></li>
          </ol>
        </li>
        <li><a href="#异步日志系统">异步日志系统</a>
          <ol>
            <li><a href="#简介-1">简介</a></li>
            <li><a href="#源码解析-1">源码解析</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#总结与感悟">总结与感悟</a></li>
    <li><a href="#源码阅读进阶">源码阅读进阶</a></li>
    <li><a href="#扩展知识">扩展知识</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/posts/%E9%AB%98%E6%95%88%E4%B9%8B%E7%BE%8Ec&#43;&#43;14/">
                <img src="/posts/%E9%AB%98%E6%95%88%E4%B9%8B%E7%BE%8Ec&#43;&#43;14/webserver_cover_hu6934887694014871526.jpg"
                        srcset="/posts/%E9%AB%98%E6%95%88%E4%B9%8B%E7%BE%8Ec&#43;&#43;14/webserver_cover_hu6934887694014871526.jpg 800w, /posts/%E9%AB%98%E6%95%88%E4%B9%8B%E7%BE%8Ec&#43;&#43;14/webserver_cover_hu4759247491841406622.jpg 1600w"
                        width="800" 
                        height="289" 
                        loading="lazy"
                        alt="Featured image of post 高效之美：C&#43;&#43;14 WebServer 源码探秘" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/%E7%BC%96%E7%A8%8B%E5%BC%80%E5%8F%91/" style="background-color: #1c62a9; color: #fff;">
                编程开发
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/posts/%E9%AB%98%E6%95%88%E4%B9%8B%E7%BE%8Ec&#43;&#43;14/">高效之美：C&#43;&#43;14 WebServer 源码探秘</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            源码解读C&#43;&#43;14打造的高性能WebServer，轻松实现上万QPS的优化与实践。
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Jun 22, 2024</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    阅读时长: 17 分钟
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h2 id="参考资料">参考资料
</h2><ul>
<li><a class="link" href="https://github.com/qiyueliuhuo/WebServer"  target="_blank" rel="noopener"
    >WebServer 源码</a></li>
<li><a class="link" href="https://learn.microsoft.com/zh-cn/cpp/cpp/?view=msvc-170"  target="_blank" rel="noopener"
    >C++ 语言文档 | Microsoft Learn</a></li>
<li><a class="link" href="https://juejin.cn/post/7098659904721780749"  target="_blank" rel="noopener"
    >C++ Linux轻量级WebServer</a></li>
<li>《深入理解C++11：C++11 新特性解析与应用》书籍</li>
</ul>
<h2 id="前言">前言
</h2><h3 id="谁适合阅读这篇文章">谁适合阅读这篇文章？
</h3><ul>
<li><strong>具备 C++ 基础</strong>：对线程池和网络编程有一定了解，希望进一步深入相关技术。</li>
<li><strong>热衷于 C++14 的应用</strong>：对现代 C++ 特性感兴趣，并追求更高的代码性能和效率。</li>
<li><strong>对 Web 服务器实现感兴趣</strong>：想要理解 Web 服务器的核心原理和实现细节，从源码到原理全方位掌握。</li>
</ul>
<h3 id="如何更好地阅读本篇文章">如何更好地阅读本篇文章？
</h3><ol>
<li>
<p><strong>针对希望通过本篇文章了解 WebServer 实现原理的读者</strong>：</p>
<p>建议使用 Snipaste 等贴图工具，将<strong>代码片段或原理示意图</strong>固定在电脑屏幕的显眼位置。这样在阅读源码解析时，可以随时对照代码或参考原理图，帮助更直观地理解 WebServer 的设计思路和实现细节。</p>
</li>
<li>
<p><strong>针对希望深入研究源码并亲自动手实践的读者</strong>：</p>
<p>强烈推荐使用 VS Code 等现代化 IDE，并确保安装支持 C++14 的编译器。参考<a class="link" href="http://localhost:1313/posts/gdb%E8%B0%83%E8%AF%95%E5%AD%A6%E4%B9%A0/" >GDB 调试秘籍：像高手一样排查问题</a>，<strong>通过逐步调试代码的方式，深入分析其运行过程</strong>。这样的实践方法不仅能加深对源码的理解，还能有效提升调试技能和对程序逻辑的掌控能力。</p>
</li>
</ol>
<h2 id="项目简介">项目简介
</h2><p>该项目是用 C++14 实现的高性能WEB服务器，经过 webbenchh 压力测试可以实现上万的QPS，通过该项目达到以下目的：</p>
<ul>
<li>阅读源码提升自己编程水平；</li>
<li>进一步理解 HTTP 协议；</li>
<li>熟悉 C++14 相关工具；</li>
<li>熟悉线程池；</li>
<li>理解 IO 复用技术 Epoll；</li>
<li>熟悉定时器的设计与实现；</li>
<li>熟悉异步日志系统的设计；</li>
</ul>
<h2 id="项目目录结构">项目目录结构
</h2><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">.
</span></span><span class="line"><span class="cl">├── code           源代码
</span></span><span class="line"><span class="cl">│   ├── buffer
</span></span><span class="line"><span class="cl">│   ├── config
</span></span><span class="line"><span class="cl">│   ├── http
</span></span><span class="line"><span class="cl">│   ├── log
</span></span><span class="line"><span class="cl">│   ├── timer
</span></span><span class="line"><span class="cl">│   ├── pool
</span></span><span class="line"><span class="cl">│   ├── server
</span></span><span class="line"><span class="cl">│   └── main.cpp
</span></span><span class="line"><span class="cl">├── <span class="nb">test</span>           单元测试
</span></span><span class="line"><span class="cl">│   ├── Makefile
</span></span><span class="line"><span class="cl">│   └── test.cpp
</span></span><span class="line"><span class="cl">├── resources      静态资源
</span></span><span class="line"><span class="cl">│   ├── index.html
</span></span><span class="line"><span class="cl">│   ├── image
</span></span><span class="line"><span class="cl">│   ├── video
</span></span><span class="line"><span class="cl">│   ├── js
</span></span><span class="line"><span class="cl">│   └── css
</span></span><span class="line"><span class="cl">├── bin            可执行文件
</span></span><span class="line"><span class="cl">│   └── server
</span></span><span class="line"><span class="cl">├── log            日志文件
</span></span><span class="line"><span class="cl">├── webbench-1.5   压力测试
</span></span><span class="line"><span class="cl">├── build          
</span></span><span class="line"><span class="cl">│   └── Makefile
</span></span><span class="line"><span class="cl">├── Makefile
</span></span><span class="line"><span class="cl">├── LICENSE
</span></span><span class="line"><span class="cl">└── readme.md
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="项目启动">项目启动
</h2><h3 id="配置数据库">配置数据库
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="o">//</span><span class="w"> </span><span class="err">建立</span><span class="n">yourdb库</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">create</span><span class="w"> </span><span class="k">database</span><span class="w"> </span><span class="n">webserver</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">//</span><span class="w"> </span><span class="err">创建</span><span class="n">user表</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">USE</span><span class="w"> </span><span class="n">webserver</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">user</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">username</span><span class="w"> </span><span class="kt">char</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="no">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">password</span><span class="w"> </span><span class="kt">char</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="no">NULL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="kp">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">//</span><span class="w"> </span><span class="err">添加数据</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="k">user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">password</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="s1">&#39;zhangsan&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;123456&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="k">user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">password</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="s1">&#39;lisi&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;123456&#39;</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>数据库中数据如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mysql&gt; USE webserver<span class="p">;</span>
</span></span><span class="line"><span class="cl">Reading table information <span class="k">for</span> completion of table and column names
</span></span><span class="line"><span class="cl">You can turn off this feature to get a quicker startup with -A
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Database changed
</span></span><span class="line"><span class="cl">mysql&gt; SHOW tables<span class="p">;</span>
</span></span><span class="line"><span class="cl">+---------------------+
</span></span><span class="line"><span class="cl"><span class="p">|</span> Tables_in_webserver <span class="p">|</span>
</span></span><span class="line"><span class="cl">+---------------------+
</span></span><span class="line"><span class="cl"><span class="p">|</span> user                <span class="p">|</span>
</span></span><span class="line"><span class="cl">+---------------------+
</span></span><span class="line"><span class="cl"><span class="m">1</span> row in <span class="nb">set</span> <span class="o">(</span>0.00 sec<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mysql&gt; SELECT * FROM user<span class="p">;</span>
</span></span><span class="line"><span class="cl">+----------+----------+
</span></span><span class="line"><span class="cl"><span class="p">|</span> username <span class="p">|</span> password <span class="p">|</span>
</span></span><span class="line"><span class="cl">+----------+----------+
</span></span><span class="line"><span class="cl"><span class="p">|</span> zhangsan <span class="p">|</span> <span class="m">123456</span>   <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> lisi     <span class="p">|</span> <span class="m">123456</span>   <span class="p">|</span>
</span></span><span class="line"><span class="cl">+----------+----------+
</span></span><span class="line"><span class="cl"><span class="m">2</span> rows in <span class="nb">set</span> <span class="o">(</span>0.00 sec<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="编译运行">编译运行
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">make
</span></span><span class="line"><span class="cl">./bin/server
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="压力测试">压力测试
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">./webbench-1.5/webbench -c <span class="m">100</span> -t <span class="m">10</span> http://ip:port/
</span></span><span class="line"><span class="cl">./webbench-1.5/webbench -c <span class="m">1000</span> -t <span class="m">10</span> http://ip:port/
</span></span><span class="line"><span class="cl">./webbench-1.5/webbench -c <span class="m">5000</span> -t <span class="m">10</span> http://ip:port/
</span></span><span class="line"><span class="cl">./webbench-1.5/webbench -c <span class="m">10000</span> -t <span class="m">10</span> http://ip:port/
</span></span></code></pre></td></tr></table>
</div>
</div><p>测试结果如下：</p>
<p><img src="/posts/%E9%AB%98%E6%95%88%E4%B9%8B%E7%BE%8Ec&#43;&#43;14/Pasted_image_20230119205336.png"
	width="817"
	height="154"
	srcset="/posts/%E9%AB%98%E6%95%88%E4%B9%8B%E7%BE%8Ec&#43;&#43;14/Pasted_image_20230119205336_hu3044889250887868869.png 480w, /posts/%E9%AB%98%E6%95%88%E4%B9%8B%E7%BE%8Ec&#43;&#43;14/Pasted_image_20230119205336_hu6083240504045034431.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="530"
		data-flex-basis="1273px"
	
></p>
<h2 id="功能介绍">功能介绍
</h2><ul>
<li>利用<strong>IO复用技术Epoll</strong>与<strong>线程池</strong>实现多线程的Reactor高并发模型；</li>
<li>利用<strong>正则与状态机</strong>解析HTTP请求报文，实现处理静态资源的请求；</li>
<li>利用标准库容器封装char，实现自动增长的缓冲区；</li>
<li>基于<strong>小根堆</strong>实现的定时器，关闭超时的非活动连接；</li>
<li>利用<strong>单例模式与阻塞队列</strong>实现异步的<strong>日志系统</strong>，记录服务器运行状态；</li>
<li>利用<strong>RAII机制</strong>实现了数据库连接池，减少数据库连接建立与关闭的开销，同时实现了用户注册登录功能。</li>
</ul>
<h2 id="时序图">时序图
</h2><p><img src="/posts/%E9%AB%98%E6%95%88%E4%B9%8B%E7%BE%8Ec&#43;&#43;14/sequence_diagram.png"
	width="1071"
	height="1959"
	srcset="/posts/%E9%AB%98%E6%95%88%E4%B9%8B%E7%BE%8Ec&#43;&#43;14/sequence_diagram_hu11580579612280791421.png 480w, /posts/%E9%AB%98%E6%95%88%E4%B9%8B%E7%BE%8Ec&#43;&#43;14/sequence_diagram_hu2815375168082296442.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="54"
		data-flex-basis="131px"
	
></p>
<p>上面时序图展示了 <code>WebServer</code> 从服务启动时进行资源初始化、客户端发送一个 <code>HTTP</code> 请求到 <code>WebServer</code> 服务器、监听套接字的 <code>Epoller</code> 接受到 <code>TCP</code> 连接请求并进行分发的过程。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;server/webserver.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* 守护进程 后台运行 */</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//daemon(1, 0); 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="n">WebServer</span> <span class="n">server</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="mi">1316</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">60000</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span>             <span class="cm">/* 端口 ET模式 timeoutMs 优雅退出  */</span>
</span></span><span class="line"><span class="cl">        <span class="mi">3306</span><span class="p">,</span> <span class="s">&#34;root&#34;</span><span class="p">,</span> <span class="s">&#34;123456&#34;</span><span class="p">,</span> <span class="s">&#34;webserver&#34;</span><span class="p">,</span> <span class="cm">/* Mysql配置 */</span>
</span></span><span class="line"><span class="cl">        <span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span>             <span class="cm">/* 连接池数量 线程池数量 日志开关 日志等级 日志异步队列容量 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">server</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面代码为 <code>WebServer</code> 服务器实例化时资源加载和实例启动源码，该阶段完成上面时序图 <code>Resource initialization</code> 框标的过程。</p>
<p>编译运行后，当我们启动时，首先通过上面代码启动服务，这时一个 HTTP 服务器开始对外服务，我们可以在游览器中访问地址：<code>http://127.0.0.1:1316</code> ，打开如下界面。</p>
<p><img src="/posts/%E9%AB%98%E6%95%88%E4%B9%8B%E7%BE%8Ec&#43;&#43;14/Pasted_image_20230128122020.png"
	width="1920"
	height="1010"
	srcset="/posts/%E9%AB%98%E6%95%88%E4%B9%8B%E7%BE%8Ec&#43;&#43;14/Pasted_image_20230128122020_hu3050355349569153767.png 480w, /posts/%E9%AB%98%E6%95%88%E4%B9%8B%E7%BE%8Ec&#43;&#43;14/Pasted_image_20230128122020_hu6620091844162953603.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="190"
		data-flex-basis="456px"
	
></p>
<p>通过游览器访问时，这里游览器给服务器发送了一个处于应用层 <code>HTTP</code> 协议的 <code>GET</code> 请求，上面时序图<strong>绿色箭头</strong>代表客户端用户主动发起请求路径为 <code>/</code> 的请求，该请求会被 <code>Linux</code> 内核提供给应用程序的<strong>同时监听多个文件描述符的事件通知机制 <code>epoll</code> 响应</strong>，那么为什么 <code>epoll</code> 会处理这样的网络请求呢？</p>
<p>在 <code>Resource initialization</code> 资源初始化阶段，就在 <code>WebServer::InitSocket_()</code> 函数中通过 <code>socket</code> 传输层编程设置一个<strong>绑定到协议为 <code>TCP</code> 且端口为 <code>1316</code></strong> 上的网络监听套接字 <code>listenFd_</code> ，通过调用 <code>listen(listenFd_, 6)</code> 该监听套接字一直处于监听状态；而且，通过 <code>epoller_-&gt;AddFd(listenFd_,  listenEvent_ | EPOLLIN)</code> 调用，将<strong>该套接字添加到多路复用机制 <code>epoll</code> 的注册事件中</strong>，该过程的代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">WebServer</span><span class="o">::</span><span class="n">InitSocket_</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="nc">sockaddr_in</span> <span class="n">addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">port_</span> <span class="o">&gt;</span> <span class="mi">65535</span> <span class="o">||</span> <span class="n">port_</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOG_ERROR</span><span class="p">(</span><span class="s">&#34;Port:%d error!&#34;</span><span class="p">,</span>  <span class="n">port_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">INADDR_ANY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">port_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="nc">linger</span> <span class="n">optLinger</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">openLinger_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* 优雅关闭: 直到所剩数据发送完毕或超时 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">optLinger</span><span class="p">.</span><span class="n">l_onoff</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">optLinger</span><span class="p">.</span><span class="n">l_linger</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">listenFd_</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">listenFd_</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOG_ERROR</span><span class="p">(</span><span class="s">&#34;Create socket error!&#34;</span><span class="p">,</span> <span class="n">port_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="n">setsockopt</span><span class="p">(</span><span class="n">listenFd_</span><span class="p">,</span> <span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">SO_LINGER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">optLinger</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">optLinger</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">close</span><span class="p">(</span><span class="n">listenFd_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOG_ERROR</span><span class="p">(</span><span class="s">&#34;Init linger error!&#34;</span><span class="p">,</span> <span class="n">port_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">optval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* 端口复用 */</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* 只有最后一个套接字会正常接收数据。 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="n">setsockopt</span><span class="p">(</span><span class="n">listenFd_</span><span class="p">,</span> <span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="p">(</span><span class="k">const</span> <span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">optval</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOG_ERROR</span><span class="p">(</span><span class="s">&#34;set socket setsockopt error !&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">close</span><span class="p">(</span><span class="n">listenFd_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="n">bind</span><span class="p">(</span><span class="n">listenFd_</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOG_ERROR</span><span class="p">(</span><span class="s">&#34;Bind Port:%d error!&#34;</span><span class="p">,</span> <span class="n">port_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">close</span><span class="p">(</span><span class="n">listenFd_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="n">listen</span><span class="p">(</span><span class="n">listenFd_</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOG_ERROR</span><span class="p">(</span><span class="s">&#34;Listen port:%d error!&#34;</span><span class="p">,</span> <span class="n">port_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">close</span><span class="p">(</span><span class="n">listenFd_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="n">epoller_</span><span class="o">-&gt;</span><span class="n">AddFd</span><span class="p">(</span><span class="n">listenFd_</span><span class="p">,</span>  <span class="n">listenEvent_</span> <span class="o">|</span> <span class="n">EPOLLIN</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOG_ERROR</span><span class="p">(</span><span class="s">&#34;Add listen error!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">close</span><span class="p">(</span><span class="n">listenFd_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">SetFdNonblock</span><span class="p">(</span><span class="n">listenFd_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">LOG_INFO</span><span class="p">(</span><span class="s">&#34;Server port:%d&#34;</span><span class="p">,</span> <span class="n">port_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>接着上面，用户发起请求，此时，<code>Linux</code> 内核唤醒起工作在设置了超时阻塞的 <code>epoller_-&gt;Wait(timeMS)</code> ，并且返回事件个数。这里，我们看到设置了超时阻塞等待，因为可能达到超时时间，没有任何事件发生，此时，通过外层 <code>while</code> 循环进入到下一轮循环中，并且当获取最小设置的超时间，继续在 <code>epoller_</code> 上等待事件发生。该过程如下面代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">WebServer</span><span class="o">::</span><span class="n">Start</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">timeMS</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>  <span class="cm">/* epoll wait timeout == -1 无事件将阻塞 */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">isClose_</span><span class="p">)</span> <span class="p">{</span> <span class="n">LOG_INFO</span><span class="p">(</span><span class="s">&#34;========== Server start ==========&#34;</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">isClose_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">timeoutMS_</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">timeMS</span> <span class="o">=</span> <span class="n">timer_</span><span class="o">-&gt;</span><span class="n">GetNextTick</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">eventCnt</span> <span class="o">=</span> <span class="n">epoller_</span><span class="o">-&gt;</span><span class="n">Wait</span><span class="p">(</span><span class="n">timeMS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">eventCnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/* 处理事件 */</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">epoller_</span><span class="o">-&gt;</span><span class="n">GetEventFd</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint32_t</span> <span class="n">events</span> <span class="o">=</span> <span class="n">epoller_</span><span class="o">-&gt;</span><span class="n">GetEvents</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="n">listenFd_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">DealListen_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">events</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">EPOLLRDHUP</span> <span class="o">|</span> <span class="n">EPOLLHUP</span> <span class="o">|</span> <span class="n">EPOLLERR</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">assert</span><span class="p">(</span><span class="n">users_</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">CloseConn_</span><span class="p">(</span><span class="o">&amp;</span><span class="n">users_</span><span class="p">[</span><span class="n">fd</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">EPOLLIN</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">assert</span><span class="p">(</span><span class="n">users_</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">DealRead_</span><span class="p">(</span><span class="o">&amp;</span><span class="n">users_</span><span class="p">[</span><span class="n">fd</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">EPOLLOUT</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">assert</span><span class="p">(</span><span class="n">users_</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">DealWrite_</span><span class="p">(</span><span class="o">&amp;</span><span class="n">users_</span><span class="p">[</span><span class="n">fd</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">LOG_ERROR</span><span class="p">(</span><span class="s">&#34;Unexpected event&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>拿到事件个数，通过循环遍历事件，进行处理事件。这里，通过 <code>int fd = epoller_-&gt;GetEventFd(i); uint32_t events = epoller_-&gt;GetEvents(i);</code> 代码获取具体事件发生<strong>哪个文件描述符上和对应的事件类型</strong>。具体参考：[[Linux 服务器编程-IO模式]]</p>
<p>在这里，我们可以通过工具 <code>gdb</code> 进行调试，通过断点来观察当发起请求时的事件类型。运行下面命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ gdb ./bin/server  <span class="c1"># 进入调试</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在这里，采用<strong>条件断点</strong>，当有具体事件返回时，才暂停运行，如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Type <span class="s2">&#34;apropos word&#34;</span> to search <span class="k">for</span> commands related to <span class="s2">&#34;word&#34;</span>...
</span></span><span class="line"><span class="cl">Reading symbols from ./bin/server...
</span></span><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span>  b code/server/webserver.cpp:85 <span class="k">if</span> eventCnt &gt; <span class="m">0</span>
</span></span><span class="line"><span class="cl">Breakpoint <span class="m">1</span> at 0x5123e: file ../code/server/webserver.cpp, line 85.
</span></span><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> r
</span></span><span class="line"><span class="cl">Starting program: /home/andy/Workplace/cpp_advance/cpp14/WebServer/bin/server 
</span></span><span class="line"><span class="cl">warning: Error disabling address space randomization: Operation not permitted
</span></span><span class="line"><span class="cl"><span class="o">[</span>Thread debugging using libthread_db enabled<span class="o">]</span>
</span></span><span class="line"><span class="cl">Using host libthread_db library <span class="s2">&#34;/lib/x86_64-linux-gnu/libthread_db.so.1&#34;</span>.
</span></span><span class="line"><span class="cl"><span class="o">[</span>New Thread 0x7f62a5409640 <span class="o">(</span>LWP 2889<span class="o">)]</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>New Thread 0x7f62a4c08640 <span class="o">(</span>LWP 2890<span class="o">)]</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>New Thread 0x7f62a4407640 <span class="o">(</span>LWP 2891<span class="o">)]</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>New Thread 0x7f62a3c06640 <span class="o">(</span>LWP 2892<span class="o">)]</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>New Thread 0x7f62a3405640 <span class="o">(</span>LWP 2893<span class="o">)]</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>New Thread 0x7f62a2c04640 <span class="o">(</span>LWP 2894<span class="o">)]</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>New Thread 0x7f62a2403640 <span class="o">(</span>LWP 2895<span class="o">)]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>此时，我们刷新游览器，重新发起请求，如下，可以看到成功返回在 <code>socket</code> 监听套接字上的事件，事件类型为 <code>EPOLLIN</code>，表示对应的<strong>文件描述符可以读</strong>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Thread <span class="m">1</span> <span class="s2">&#34;server&#34;</span> hit Breakpoint 1, WebServer::Start <span class="o">(</span><span class="nv">this</span><span class="o">=</span>0x7ffd64d41970<span class="o">)</span> at ../code/server/webserver.cpp:85
</span></span><span class="line"><span class="cl"><span class="m">85</span>              <span class="k">for</span><span class="o">(</span>int <span class="nv">i</span> <span class="o">=</span> 0<span class="p">;</span> i &lt; eventCnt<span class="p">;</span> i++<span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> p eventCnt
</span></span><span class="line"><span class="cl"><span class="nv">$1</span> <span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> n
</span></span><span class="line"><span class="cl"><span class="m">87</span>                  int <span class="nv">fd</span> <span class="o">=</span> epoller_-&gt;GetEventFd<span class="o">(</span>i<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> n
</span></span><span class="line"><span class="cl"><span class="m">88</span>                  uint32_t <span class="nv">events</span> <span class="o">=</span> epoller_-&gt;GetEvents<span class="o">(</span>i<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> n
</span></span><span class="line"><span class="cl"><span class="m">89</span>                  <span class="k">if</span><span class="o">(</span><span class="nv">fd</span> <span class="o">==</span> listenFd_<span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> n
</span></span><span class="line"><span class="cl"><span class="m">90</span>                      DealListen_<span class="o">()</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> p events <span class="p">&amp;</span> EPOLLIN
</span></span><span class="line"><span class="cl"><span class="nv">$2</span> <span class="o">=</span> <span class="m">1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>下面代码我们来看看当第一次发起请求时，客户端是如何与服务端建立并保持一个<strong>计时连接</strong>，并且如何处理一个 <code>HTTP</code> 的资源请求的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">WebServer</span><span class="o">::</span><span class="n">AddClient_</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="n">sockaddr_in</span> <span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">fd</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">users_</span><span class="p">[</span><span class="n">fd</span><span class="p">].</span><span class="n">init</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">timeoutMS_</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">timer_</span><span class="o">-&gt;</span><span class="n">add</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">timeoutMS_</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">WebServer</span><span class="o">::</span><span class="n">CloseConn_</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">users_</span><span class="p">[</span><span class="n">fd</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">epoller_</span><span class="o">-&gt;</span><span class="n">AddFd</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">EPOLLIN</span> <span class="o">|</span> <span class="n">connEvent_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">SetFdNonblock</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">LOG_INFO</span><span class="p">(</span><span class="s">&#34;Client[%d] in!&#34;</span><span class="p">,</span> <span class="n">users_</span><span class="p">[</span><span class="n">fd</span><span class="p">].</span><span class="n">GetFd</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">WebServer</span><span class="o">::</span><span class="n">DealListen_</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="nc">sockaddr_in</span> <span class="n">addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">socklen_t</span> <span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">listenFd_</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">fd</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">HttpConn</span><span class="o">::</span><span class="n">userCount</span> <span class="o">&gt;=</span> <span class="n">MAX_FD</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">SendError_</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">&#34;Server busy!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">LOG_WARN</span><span class="p">(</span><span class="s">&#34;Clients is full!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">AddClient_</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="n">listenEvent_</span> <span class="o">&amp;</span> <span class="n">EPOLLET</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面代码可以看到，当客户端与服务端建立连接后，会通过 <code>accept(listenFd_, (struct sockaddr *)&amp;addr, &amp;len)</code> 在服务端返回一个<strong>新的 <code>socket</code> 套接字</strong>，即文件描述符 <code>fd</code>，此时，在传输层上已经建立了 <code>TCP</code> 稳定连接；之后服务端生成一个<strong>表示连接的对象 <code>HttpConn</code></strong> ，存入 <code>users_</code> 字典中；表示一个连接对象的 <code>HttpConn</code> 中，保存了上面新的套接字 <code>fd_</code>、客户端地址 <code>addr_</code>以及该连接的状态 <code>isClose_</code>；之后，通过 <code>epoller_-&gt;AddFd(fd, EPOLLIN | connEvent_)</code> 将这个新的套接字也加入到 <code>epoll</code> 事件监听中，<code>WebServer::DealListen_()</code> 在没有其他客户端试图建立连接时，通过语句 <code>if(fd &lt;= 0) { return;}</code> 返回到 <code>WebServer::Start()</code> 函数的外层循环中。此时，客户端因为首次发起连接，服务端成功与客户端建立连接，并且监听<strong>相应的新的网络套接字</strong>。</p>
<p>由于首次发起连接时，客户端向服务端发送数据包，该数据包还未被读取，此时，新的 <code>socket</code> 套接字 <code>fd</code> 处于可读状态 <code>EPOLLIN</code>，因此在 <code>WebServer::Start()</code> 函数的外层循环 <code>while(!isClose_)</code> 执行到 <code>int eventCnt = epoller_-&gt;Wait(timeMS)</code> 语句时，<strong>会立即返回事件数</strong>，如果没有其他客户端发起连接，那么只有刚才成功建立连接的客户端，那么此时，事件数为 1，并且该事件发生在建立 <code>TCP</code> 连接的套接字 <code>fd</code> 上且事件为 <code>EPOLLIN</code>，此时，调用 <code>DealRead_(&amp;users_[fd])</code> 处理该请求并且处理 <code>HTTP</code> 协议的信息后，构造客户端请求对应的 <code>HTTP</code> 资源，并且通过  <code>epoller_-&gt;ModFd(client-&gt;GetFd(), connEvent_ | EPOLLOUT)</code> 使得 <code>epoll</code> 机制在套接字 <code>fd</code> 上<strong>同时监听是否可写</strong>的状态。下面代码展示了该过程：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">WebServer</span><span class="o">::</span><span class="n">DealRead_</span><span class="p">(</span><span class="n">HttpConn</span><span class="o">*</span> <span class="n">client</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ExtentTime_</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">threadpool_</span><span class="o">-&gt;</span><span class="n">AddTask</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">WebServer</span><span class="o">::</span><span class="n">OnRead_</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">client</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">WebServer</span><span class="o">::</span><span class="n">OnRead_</span><span class="p">(</span><span class="n">HttpConn</span><span class="o">*</span> <span class="n">client</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">readErrno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">readErrno</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">readErrno</span> <span class="o">!=</span> <span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">CloseConn_</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">OnProcess</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">WebServer</span><span class="o">::</span><span class="n">OnProcess</span><span class="p">(</span><span class="n">HttpConn</span><span class="o">*</span> <span class="n">client</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">process</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">epoller_</span><span class="o">-&gt;</span><span class="n">ModFd</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">GetFd</span><span class="p">(),</span> <span class="n">connEvent_</span> <span class="o">|</span> <span class="n">EPOLLOUT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">epoller_</span><span class="o">-&gt;</span><span class="n">ModFd</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">GetFd</span><span class="p">(),</span> <span class="n">connEvent_</span> <span class="o">|</span> <span class="n">EPOLLIN</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">HttpConn</span><span class="o">::</span><span class="n">process</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">request_</span><span class="p">.</span><span class="n">Init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">readBuff_</span><span class="p">.</span><span class="n">ReadableBytes</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">request_</span><span class="p">.</span><span class="n">parse</span><span class="p">(</span><span class="n">readBuff_</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOG_DEBUG</span><span class="p">(</span><span class="s">&#34;%s&#34;</span><span class="p">,</span> <span class="n">request_</span><span class="p">.</span><span class="n">path</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">response_</span><span class="p">.</span><span class="n">Init</span><span class="p">(</span><span class="n">srcDir</span><span class="p">,</span> <span class="n">request_</span><span class="p">.</span><span class="n">path</span><span class="p">(),</span> <span class="n">request_</span><span class="p">.</span><span class="n">IsKeepAlive</span><span class="p">(),</span> <span class="mi">200</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">response_</span><span class="p">.</span><span class="n">Init</span><span class="p">(</span><span class="n">srcDir</span><span class="p">,</span> <span class="n">request_</span><span class="p">.</span><span class="n">path</span><span class="p">(),</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">400</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">response_</span><span class="p">.</span><span class="n">MakeResponse</span><span class="p">(</span><span class="n">writeBuff_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* 响应头 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">iov_</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="k">const_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">writeBuff_</span><span class="p">.</span><span class="n">Peek</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">iov_</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">writeBuff_</span><span class="p">.</span><span class="n">ReadableBytes</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">iovCnt_</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* 文件 */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">response_</span><span class="p">.</span><span class="n">FileLen</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span>  <span class="o">&amp;&amp;</span> <span class="n">response_</span><span class="p">.</span><span class="n">File</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">iov_</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">response_</span><span class="p">.</span><span class="n">File</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">iov_</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">response_</span><span class="p">.</span><span class="n">FileLen</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">iovCnt_</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">LOG_DEBUG</span><span class="p">(</span><span class="s">&#34;filesize:%d, %d  to %d&#34;</span><span class="p">,</span> <span class="n">response_</span><span class="p">.</span><span class="n">FileLen</span><span class="p">()</span> <span class="p">,</span> <span class="n">iovCnt_</span><span class="p">,</span> <span class="n">ToWriteBytes</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>与上面情况类似，当 <code>DealRead_(&amp;users_[fd])</code> 执行结束后，并且结束内层循环后，下一轮外层外层循环 <code>while(!isClose_)</code> 执行到 <code>int eventCnt = epoller_-&gt;Wait(timeMS)</code> 语句时，<strong>会立即返回事件数</strong>，此时，如果没有其他客户端发起连接，只有刚才成功建立连接的客户端，那么此时，事件数为 1，并且该事件发生在建立 <code>TCP</code> 连接的套接字 <code>fd</code> 上且事件为 <code>EPOLLOUT</code>，此时，执行调用 <code>DealWrite_(&amp;users_[fd])</code> 将上面构建的构造客户端请求对应的 <code>HTTP</code> 资源，即 <code>HttpConn</code> 中的 <code>response_</code> 内容发送给客户端。下面代码展示了该过程：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">WebServer</span><span class="o">::</span><span class="n">DealWrite_</span><span class="p">(</span><span class="n">HttpConn</span><span class="o">*</span> <span class="n">client</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ExtentTime_</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">threadpool_</span><span class="o">-&gt;</span><span class="n">AddTask</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">WebServer</span><span class="o">::</span><span class="n">OnWrite_</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">client</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">WebServer</span><span class="o">::</span><span class="n">OnWrite_</span><span class="p">(</span><span class="n">HttpConn</span><span class="o">*</span> <span class="n">client</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">writeErrno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">writeErrno</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">ToWriteBytes</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* 传输完成 */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">IsKeepAlive</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">OnProcess</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">writeErrno</span> <span class="o">==</span> <span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/* 继续传输 */</span>
</span></span><span class="line"><span class="cl">            <span class="n">epoller_</span><span class="o">-&gt;</span><span class="n">ModFd</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">GetFd</span><span class="p">(),</span> <span class="n">connEvent_</span> <span class="o">|</span> <span class="n">EPOLLOUT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">CloseConn_</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="关键技术">关键技术
</h2><h3 id="io复用技术-epoll">IO复用技术 Epoll
</h3><p>具体参考 [[Linux 服务器编程-IO模式#epoll]]</p>
<h3 id="线程池">线程池
</h3><h4 id="简介">简介
</h4><p>线程池（Thread Pool）是一种基于池化思想管理线程的工具，经常出现在多线程服务器中，如MySQL。</p>
<p>线程过多会带来额外的开销，其中包括创建销毁线程的开销、调度线程的开销等等，同时也降低了计算机的整体性能。线程池维护多个线程，等待监督管理者分配可并发执行的任务。这种做法，一方面避免了处理任务时创建销毁线程开销的代价，另一方面避免了线程数量膨胀导致的过分调度问题，保证了对内核的充分利用。</p>
<p>而本文描述的是一种简单的线程池实现方案，更复杂的线程池实现方法，请参考下面的资料学习。</p>
<h4 id="参考资料-1">参考资料
</h4><ul>
<li><a class="link" href="https://tech.meituan.com/2020/04/02/java-pooling-pratice-in-meituan.html"  target="_blank" rel="noopener"
    >Java线程池实现原理及其在美团业务中的实践 - 美团技术团队</a></li>
<li><a class="link" href="https://github.com/allentofight/easy-cs/blob/main/Java/2w%E5%AD%97%E9%95%BF%E6%96%87%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%E7%BA%BF%E7%A8%8B%E6%B1%A0.md"  target="_blank" rel="noopener"
    >2w字长文深度解析线程池</a></li>
</ul>
<h4 id="代码解析">代码解析
</h4><p>为了方便理解代码，在这里我先通过下面示意图，简单描述该版本的线程池大概机制。</p>
<p><img src="/posts/%E9%AB%98%E6%95%88%E4%B9%8B%E7%BE%8Ec&#43;&#43;14/Pasted_image_20230122192122.png"
	width="1646"
	height="558"
	srcset="/posts/%E9%AB%98%E6%95%88%E4%B9%8B%E7%BE%8Ec&#43;&#43;14/Pasted_image_20230122192122_hu16231596378880326964.png 480w, /posts/%E9%AB%98%E6%95%88%E4%B9%8B%E7%BE%8Ec&#43;&#43;14/Pasted_image_20230122192122_hu11990487892743236621.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="294"
		data-flex-basis="707px"
	
></p>
<p>下面代码实现了一个如上图线程池，整个线程池是个生产者消费者模型，该线程池一开始创建 <code>threadCount</code> 个固定线程，这些线程作为消费者，当线程被唤醒时，从任务队列中获取任务，执行任务；而生产者通过 <code>AddTask(F&amp;&amp; task)</code> 方法将生产的任务添加到<strong>任务缓冲队列</strong>中。可以看到，整个<code>TaskQueue</code> 任务队列作为临界资源被多个线程异步访问，为了保障多个线程能够安全访问 <code>TaskQueue</code> 中 <code>std::queue&lt;std::function&lt;void()&gt;&gt; tasks</code> 队列 变量时，每次操作都需要通过互斥量 <code>std::mutex mtx</code> 进行加锁后再进行访问。</p>
<blockquote>
<p>注：这里笔者将源码中 <code>Pool</code> 结构体改名成 <code>TaskQueue</code>，代表的含义更为合适。</p>
</blockquote>
<p>可以先阅读下面源码，后面给出源码相关问题及回答。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-CPP" data-lang="CPP"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @File         : threadpool.h
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @Author       : mark
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @Date         : 2020-06-15
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @copyleft Apache 2.0
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#ifndef THREADPOOL_H
</span></span></span><span class="line"><span class="cl"><span class="cp">#define THREADPOOL_H
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;mutex&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;condition_variable&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;queue&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;thread&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;functional&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="k">class</span> <span class="nc">ThreadPool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">explicit</span> <span class="n">ThreadPool</span><span class="p">(</span><span class="n">size_t</span> <span class="n">threadCount</span> <span class="o">=</span> <span class="mi">8</span><span class="p">)</span><span class="o">:</span> <span class="n">task_queue_</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">TaskQueue</span><span class="o">&gt;</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">assert</span><span class="p">(</span><span class="n">threadCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span><span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">threadCount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">([</span><span class="n">task_queue</span> <span class="o">=</span> <span class="n">task_queue_</span><span class="p">]</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">locker</span><span class="p">(</span><span class="n">task_queue</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">while</span><span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">task_queue</span><span class="o">-&gt;</span><span class="n">tasks</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="k">auto</span> <span class="n">task</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">task_queue</span><span class="o">-&gt;</span><span class="n">tasks</span><span class="p">.</span><span class="n">front</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">                            <span class="n">task_queue</span><span class="o">-&gt;</span><span class="n">tasks</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                            <span class="n">locker</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                            <span class="n">task</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                            <span class="n">locker</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span> 
</span></span><span class="line"><span class="cl">                        <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">task_queue</span><span class="o">-&gt;</span><span class="n">isClosed</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="k">else</span> <span class="n">task_queue</span><span class="o">-&gt;</span><span class="n">cond</span><span class="p">.</span><span class="n">wait</span><span class="p">(</span><span class="n">locker</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}).</span><span class="n">detach</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ThreadPool</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ThreadPool</span><span class="p">(</span><span class="n">ThreadPool</span><span class="o">&amp;&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="o">~</span><span class="n">ThreadPool</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="p">(</span><span class="n">task_queue_</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">locker</span><span class="p">(</span><span class="n">task_queue_</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">task_queue_</span><span class="o">-&gt;</span><span class="n">isClosed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">task_queue_</span><span class="o">-&gt;</span><span class="n">cond</span><span class="p">.</span><span class="n">notify_all</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">F</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="n">AddTask</span><span class="p">(</span><span class="n">F</span><span class="o">&amp;&amp;</span> <span class="n">task</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">locker</span><span class="p">(</span><span class="n">task_queue_</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">task_queue_</span><span class="o">-&gt;</span><span class="n">tasks</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&gt;</span><span class="p">(</span><span class="n">task</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">task_queue_</span><span class="o">-&gt;</span><span class="n">cond</span><span class="p">.</span><span class="n">notify_one</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="nc">TaskQueue</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">mutex</span> <span class="n">mtx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">condition_variable</span> <span class="n">cond</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">bool</span> <span class="n">isClosed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">queue</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">()</span><span class="o">&gt;&gt;</span> <span class="n">tasks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">TaskQueue</span><span class="o">&gt;</span> <span class="n">task_queue_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#endif </span><span class="c1">//THREADPOOL_H
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>为什么该线程池所有的实现在 <code>threadpool.h</code> 中完成？</p>
<blockquote>
<p>上面源码为线程池的头文件 <code>threadpool.h</code>，而且该线程池<strong>没有</strong>对应的 <code>threadpool.cpp</code> 实现代码文件，这种在类中实现方法的方式，使得类中方法都是缺省内联的，这样在编译的时候把函数调用的部分直接换成函数代码，而不是进行函数调用，这适用于函数代码少的时候，可以避免调用带来栈空间的消耗，也可以减少一定的调用时间。</p>
</blockquote>
<p><code>explicit</code> 修饰的构造函数如何理解？</p>
<blockquote>
<p>通过将构造函数声明为explicit（显式）的方式可以<strong>抑制隐式转换</strong>。也就是说，explicit构造函数必须显式调用。按默认规定，只用传一个参数的构造函数也定义了一个隐式转换。具体参考：<a class="link" href="https://veitchkyrie.github.io/2019/10/18/C&#43;&#43;-explicit%E5%85%B3%E9%94%AE%E5%AD%97-%E8%AF%A6%E8%A7%A3-%E7%94%A8%E4%BA%8E%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0/"  target="_blank" rel="noopener"
    >C++ explicit关键字详解</a></p>
</blockquote>
<p><code>std::make_shared</code> 作用是什么？在什么场景下使用？</p>
<blockquote>
<p>如有可能，第一次创建内存资源时，请使用 <code>make_shared</code> 函数创建 <code>shared_ptr</code>。 <code>make_shared</code> 异常安全。 它使用同一调用为控制块和资源分配内存，这会减少构造开销。 如果不使用 <code>make_shared</code>，则必须先使用显式 <code>new</code> 表达式来创建对象，然后才能将其传递到 <code>shared_ptr</code> 构造函数。具体参考：<a class="link" href="https://docs.microsoft.com/zh-cn/cpp/cpp/how-to-create-and-use-shared-ptr-instances?view=msvc-170"  target="_blank" rel="noopener"
    >如何：创建和使用 shared_ptr 实例</a></p>
</blockquote>
<p><code>void detach()</code> 作用？</p>
<blockquote>
<p>拆离相关联的线程。 操作系统负责释放终止的线程资源。具体参考：<a class="link" href="https://learn.microsoft.com/zh-cn/cpp/standard-library/thread-class?view=msvc-170"  target="_blank" rel="noopener"
    >thread类-detach</a></p>
</blockquote>
<p><code>std::unique_lock</code> 作用及应用场景？</p>
<blockquote>
<p>表示可进行实例化以创建管理 <code>mutex</code> 锁定和解锁的对象的模板。<code>uniqie_lock</code> 是个类模板，它的功能跟 <code>lock_quard</code> 类似，但比 <code>lock_quard</code> 更灵活。在工作中，一般用 <code>lock_quard</code> （推荐使用）就足够了，但在一些特殊的场景下会用到 <code>uniqie_lock</code>。 <code>lock_quard</code> 取代了 <code>mutex</code> 的 <code>lock()</code> 和 <code>unlock()</code>，在 <code>lock_quard</code> 的构造函数中上锁，在析构函数中解锁，这点其实在 <code>uniqie_lock</code> 中也是一样的。<code>uniqie_lock</code> 在使用上比 <code>lock_quard</code> 灵活，但代价就是效率会低一点，并且内存占用量也会相对高一些。具体参考：<a class="link" href="https://www.w3cjava.com/technical-articles/C&#43;&#43;/125380206.html"  target="_blank" rel="noopener"
    >unique_lock详解</a> 和 <a class="link" href="https://docs.microsoft.com/zh-cn/cpp/standard-library/unique-lock-class?view=msvc-170"  target="_blank" rel="noopener"
    >unique_lock 类</a></p>
</blockquote>
<p><code>std::mutex</code> 作用及应用场景？</p>
<blockquote>
<p><code>Mutex</code> 又称互斥量，C++ 11中与 <code>Mutex</code> 相关的类（包括锁类型）和函数都声明在 <code>&lt;mutex&gt;</code> 头文件中，所以如果你需要使用 <code>std::mutex</code>，就必须包含 <code>&lt;mutex&gt;</code> 头文件。<code>std::mutex</code> 是C++11 中最基本的互斥量，<code>std::mutex</code> 对象提供了独占所有权的特性——即不支持递归地对 <code>std::mutex</code> 对象上锁，而 <code>std::recursive_lock</code> 则可以递归地对互斥量对象上锁。具体参考：<a class="link" href="https://www.cnblogs.com/haippy/p/3237213.html"  target="_blank" rel="noopener"
    >C++11 并发指南三(std::mutex 详解)</a></p>
</blockquote>
<p><code>std::move</code> 与 <code>std::forward</code> 作用及应用场景？</p>
<blockquote>
<p><code>std::forward</code> 比 <code>std::move</code> 逻辑略复杂，<code>std::move</code>  是无条件把参数转换为右值，而 <code>std::forward</code> 在特定情况下才会这样做：仅当参数是用右值初始化时，才会把它转换为右值。它的意义是使外面的函数调用选择接受右值的版本，实际的移动工作是由外面的函数进行的；使用std::forward来转发参数一般被称为完美转发 (也叫精确传递)。具体参考：<a class="link" href="https://blog.csdn.net/xiangbaohui/article/details/103673177"  target="_blank" rel="noopener"
    >C++ 理解std::forward完美转发</a>。这里，使用 <code>std::move</code> 将 <code>pool-&gt;tasks.front()</code> 装换为右值，从而使得 <code>std::function</code> 类型的 task 调用 <code>function&amp; operator= (function&amp;&amp; rhs);</code> 构造函数，避免资源重复申请创建。详细讨论参考：<a class="link" href="https://www.zhihu.com/search?type=content&amp;q=std%3A%3Amove"  target="_blank" rel="noopener"
    >知乎std::move回答</a></p>
</blockquote>
<p><code>ThreadPool(ThreadPool&amp;&amp;) = default;</code> 该构造函数是什么含义？</p>
<blockquote>
<p>此语句代表<strong>显式默认构造函数</strong>，而且该构造函数为移动构造函数，移动构造函数是特殊成员函数，它将现有对象数据的所有权移交给新变量，而不复制原始数据。 它采用 rvalue 引用作为其第一个参数，以后的任何参数都必须具有默认值。 **移动构造函数在传递大型对象时可以显著提高程序的效率。**具体参考：<a class="link" href="https://learn.microsoft.com/zh-cn/cpp/cpp/explicitly-defaulted-and-deleted-functions?view=msvc-170"  target="_blank" rel="noopener"
    >显式默认设置的函数和已删除的函数 | Microsoft Learn</a> 和 <a class="link" href="https://learn.microsoft.com/zh-cn/cpp/cpp/constructors-cpp?view=msvc-170#move_constructors"  target="_blank" rel="noopener"
    >移动构造函数 (C++) | Microsoft Learn</a></p>
</blockquote>
<p>代码 <code>task_queue_-&gt;tasks.emplace(std::forward&lt;F&gt;(task));</code> 语句如何理解？</p>
<blockquote>
<p>首先，<code>task_queue_-&gt;tasks</code> 的类型是 <code>std::queue&lt;std::function&lt;void()&gt;&gt;</code>，成员函数 <code>emplace</code>，会在当前的最后一个元素之后，即队列的末尾添加了一个新元素。 这个新元素会采用元素类的构造函数够赞，并且将 <code>std::forward&lt;F&gt;(task))</code> 作为其构造函数的参数；另外，此处，<code>std::forward&lt;F&gt;</code> 将输入的参数原封不动地传递到下一个函数中，如果输入的参数是左值，那么传递给下一个函数的参数的也是左值；如果输入的参数是右值，那么传递给下一个函数的参数的也是右值。那么，当 <code>task</code> 参数是右值时，完美转发后，将会调用移动构造函数 <code>function( function&amp;&amp; other );</code> 进行构造。此处，还需更深入理解。可以参考书籍《深入理解C++11：C++11新特性解析与应用》</p>
</blockquote>
<h3 id="基于小根堆实现的定时器">基于小根堆实现的定时器
</h3><h4 id="小根堆">小根堆
</h4><p><strong>堆</strong>（Heap）是计算机科学中的一种特别的<a class="link" href="https://zh.wikipedia.org/wiki/%E5%AE%8C%E5%85%A8%E4%BA%8C%E5%8F%89%E6%A0%91"  title="完全二叉树"
     target="_blank" rel="noopener"
    >完全二叉树</a>。若是满足以下特性，即可称为堆：“给定堆中任意节点P和C，若P是C的母节点，那么P的值会小于等于（或大于等于）C的值”。若母节点的值恒<strong>小于等于</strong>子节点的值，此堆称为<strong>最小堆</strong>（min heap）；反之，若母节点的值恒<strong>大于等于</strong>子节点的值，此堆称为<strong>最大堆</strong>（max heap）。在堆中最顶端的那一个节点，称作<strong>根节点</strong>（root node），根节点本身没有<strong>母节点</strong>（parent node）。参考：<a class="link" href="https://zh.wikipedia.org/wiki/%E5%A0%86%E7%A9%8D"  target="_blank" rel="noopener"
    >堆 - 维基百科</a></p>
<p>根据上面定义可知，<strong>小根堆</strong>（min heap）的根节点总是<strong>小于等于</strong>其他任意节点。</p>
<p>那么，这里为什么要用小根堆实现定时器呢？</p>
<p>首先，定时器和我们大家常用的<strong>闹钟</strong>类似，记录到时时间，由于，服务器会保持大量的连接，因此，对于每个连接都需要记录一个定期时间（expires），这里采用 <code>C++</code> 中任何一个容器就可以了；但是，考虑到我们采用定时器是为了将那些<strong>已经超时的连接关闭</strong>，对于一个记录大量倒计时的记录来说，必然是那些<strong>定期时间时间较小</strong>的连接，首先到达超时时间，这意味着这些连接距离上次连接活动已经过去了较长时间，因此，我们每次要获取这些定期时间记录中<strong>最小</strong>记录，判断是否超时，如果小于当前时间，代表已经超时，那么关闭这个 <code>TCP</code> 连接，重复上面至获取的定期时间大于当前时间；另外，由于在 <code>WebServer::Start()</code> 中存在 <code>epoller_-&gt;Wait(timeMS)</code> ，这表明主线程会进入超时阻塞中，主动放弃 <code>CPU</code> ，当有事件发生或者到达超时时间才会被操作系统内核主动唤醒，那么，这里的参数 <code>timeMS</code>  如果设置过大，将会导致无法及时关闭超时连接，造成网络连接资源浪费；如果该参数设置过小，将会导致频繁唤醒主线程，导致 <code>CPU</code> 资源浪费。综上，我们每次获取<strong>全部连接定时器</strong>中剩余时间最短的时间，将此时间设置为 <code>timeMS</code> ，这样，就能及时关闭超时连接，也不会造成资源浪费。</p>
<h4 id="源码解析">源码解析
</h4><p>下面我们根据源码分析该定时器功能。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @File         : heaptimer.h
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @Author       : mark
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @Date         : 2020-06-17
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @copyleft Apache 2.0
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span> 
</span></span><span class="line"><span class="cl"><span class="cp">#ifndef HEAP_TIMER_H
</span></span></span><span class="line"><span class="cl"><span class="cp">#define HEAP_TIMER_H
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;queue&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unordered_map&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;time.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;algorithm&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;arpa/inet.h&gt;</span><span class="cp"> 
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;functional&gt;</span><span class="cp"> 
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;assert.h&gt;</span><span class="cp"> 
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;chrono&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;../log/log.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">()</span><span class="o">&gt;</span> <span class="n">TimeoutCallBack</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span> <span class="n">Clock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span> <span class="n">MS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="n">Clock</span><span class="o">::</span><span class="n">time_point</span> <span class="n">TimeStamp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">TimerNode</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>            <span class="c1">// 网络套接字描述符
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">TimeStamp</span> <span class="n">expires</span><span class="p">;</span> <span class="c1">// 到期时间戳
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">TimeoutCallBack</span> <span class="n">cb</span><span class="p">;</span> <span class="c1">// 到期回调函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">bool</span> <span class="k">operator</span><span class="o">&lt;</span><span class="p">(</span><span class="k">const</span> <span class="n">TimerNode</span><span class="o">&amp;</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// TimerNode 小于运算符
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="n">expires</span> <span class="o">&lt;</span> <span class="n">t</span><span class="p">.</span><span class="n">expires</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">HeapTimer</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 构造函数，并初始化当前vector容器容量为64
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">HeapTimer</span><span class="p">()</span> <span class="p">{</span> <span class="n">heap_</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span> <span class="p">}</span>  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">~</span><span class="n">HeapTimer</span><span class="p">()</span> <span class="p">{</span> <span class="n">clear</span><span class="p">();</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 调整网络套接描述符id的连接超时时间为 timeOut
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="nf">adjust</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeOut</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 添加网络套接描述符id的连接超时时间为 timeOut，并设置超时回调函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="nf">add</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeOut</span><span class="p">,</span> <span class="k">const</span> <span class="n">TimeoutCallBack</span><span class="o">&amp;</span> <span class="n">cb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 删除指定id结点，并触发回调函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="nf">doWork</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 清空堆
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="nf">clear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 清除超时节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="nf">tick</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 清楚堆顶节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="nf">pop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 获取最近到期超时连接的剩余时间ms
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="nf">GetNextTick</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 删除节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="n">del_</span><span class="p">(</span><span class="n">size_t</span> <span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 节点向上调整
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="nf">siftup_</span><span class="p">(</span><span class="n">size_t</span> <span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 节点向下调整
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">bool</span> <span class="nf">siftdown_</span><span class="p">(</span><span class="n">size_t</span> <span class="n">index</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 交换两个节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="nf">SwapNode_</span><span class="p">(</span><span class="n">size_t</span> <span class="n">i</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">j</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 用 vector 实现的小根堆
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">TimerNode</span><span class="o">&gt;</span> <span class="n">heap_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 记录网络套接描述符到 TimerNode 在 heap_ 中的位置映射关系
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">size_t</span><span class="o">&gt;</span> <span class="n">ref_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#endif </span><span class="c1">//HEAP_TIMER_H
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>HeapTimer</code> 实现：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @File         : heaptimer.cpp
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @Author       : mark
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @Date         : 2020-06-17
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @copyleft Apache 2.0
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span> 
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;heaptimer.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">HeapTimer</span><span class="o">::</span><span class="n">siftup_</span><span class="p">(</span><span class="n">size_t</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">heap_</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">size_t</span> <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">heap_</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">heap_</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span> <span class="k">break</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">SwapNode_</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">i</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">HeapTimer</span><span class="o">::</span><span class="n">SwapNode_</span><span class="p">(</span><span class="n">size_t</span> <span class="n">i</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">j</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">heap_</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">heap_</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">heap_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">heap_</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ref_</span><span class="p">[</span><span class="n">heap_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ref_</span><span class="p">[</span><span class="n">heap_</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">HeapTimer</span><span class="o">::</span><span class="n">siftdown_</span><span class="p">(</span><span class="n">size_t</span> <span class="n">index</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">heap_</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="n">heap_</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">size_t</span> <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="o">&amp;&amp;</span> <span class="n">heap_</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">heap_</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="n">j</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">heap_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">heap_</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">SwapNode_</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">i</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">HeapTimer</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span> <span class="k">const</span> <span class="n">TimeoutCallBack</span><span class="o">&amp;</span> <span class="n">cb</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">size_t</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">ref_</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* 新节点：堆尾插入，调整堆 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">i</span> <span class="o">=</span> <span class="n">heap_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">ref_</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">heap_</span><span class="p">.</span><span class="n">push_back</span><span class="p">({</span><span class="n">id</span><span class="p">,</span> <span class="n">Clock</span><span class="o">::</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">MS</span><span class="p">(</span><span class="n">timeout</span><span class="p">),</span> <span class="n">cb</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="n">siftup_</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> 
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* 已有结点：调整堆 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">i</span> <span class="o">=</span> <span class="n">ref_</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">heap_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">expires</span> <span class="o">=</span> <span class="n">Clock</span><span class="o">::</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">MS</span><span class="p">(</span><span class="n">timeout</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">heap_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cb</span> <span class="o">=</span> <span class="n">cb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">siftdown_</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">heap_</span><span class="p">.</span><span class="n">size</span><span class="p">()))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">siftup_</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">HeapTimer</span><span class="o">::</span><span class="n">doWork</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* 删除指定id结点，并触发回调函数 */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">heap_</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">||</span> <span class="n">ref_</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="n">ref_</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">TimerNode</span> <span class="n">node</span> <span class="o">=</span> <span class="n">heap_</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">node</span><span class="p">.</span><span class="n">cb</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">del_</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">HeapTimer</span><span class="o">::</span><span class="n">del_</span><span class="p">(</span><span class="n">size_t</span> <span class="n">index</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* 删除指定位置的结点 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">heap_</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">heap_</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* 将要删除的结点换到队尾，然后调整堆 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">size_t</span> <span class="n">n</span> <span class="o">=</span> <span class="n">heap_</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SwapNode_</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">siftdown_</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">siftup_</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* 队尾元素删除 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ref_</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">heap_</span><span class="p">.</span><span class="n">back</span><span class="p">().</span><span class="n">id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">heap_</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">HeapTimer</span><span class="o">::</span><span class="n">adjust</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* 调整指定id的结点 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">heap_</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">ref_</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">heap_</span><span class="p">[</span><span class="n">ref_</span><span class="p">[</span><span class="n">id</span><span class="p">]].</span><span class="n">expires</span> <span class="o">=</span> <span class="n">Clock</span><span class="o">::</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">MS</span><span class="p">(</span><span class="n">timeout</span><span class="p">);;</span>
</span></span><span class="line"><span class="cl">    <span class="n">siftdown_</span><span class="p">(</span><span class="n">ref_</span><span class="p">[</span><span class="n">id</span><span class="p">],</span> <span class="n">heap_</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">HeapTimer</span><span class="o">::</span><span class="n">tick</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* 清除超时结点 */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">heap_</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">heap_</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">TimerNode</span> <span class="n">node</span> <span class="o">=</span> <span class="n">heap_</span><span class="p">.</span><span class="n">front</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration_cast</span><span class="o">&lt;</span><span class="n">MS</span><span class="o">&gt;</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">expires</span> <span class="o">-</span> <span class="n">Clock</span><span class="o">::</span><span class="n">now</span><span class="p">()).</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">node</span><span class="p">.</span><span class="n">cb</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">pop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">HeapTimer</span><span class="o">::</span><span class="n">pop</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">heap_</span><span class="p">.</span><span class="n">empty</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">del_</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">HeapTimer</span><span class="o">::</span><span class="n">clear</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ref_</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">heap_</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">HeapTimer</span><span class="o">::</span><span class="n">GetNextTick</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">tick</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">size_t</span> <span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">heap_</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">res</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration_cast</span><span class="o">&lt;</span><span class="n">MS</span><span class="o">&gt;</span><span class="p">(</span><span class="n">heap_</span><span class="p">.</span><span class="n">front</span><span class="p">().</span><span class="n">expires</span> <span class="o">-</span> <span class="n">Clock</span><span class="o">::</span><span class="n">now</span><span class="p">()).</span><span class="n">count</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="异步日志系统">异步日志系统
</h3><h4 id="简介-1">简介
</h4><p>系统日志是用来记录服务器的运行状态，以保证系统的正常运行，记录的信息如<strong>时间日期、客户端的读写操作、当前客户端连接数量、Error与Warn状况等，Webserver是采用单例模式与阻塞队列实现的异步的日志系统</strong>，如下为日志的记录情况：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">2023-01-28 04:17:37.625250 <span class="o">[</span>info<span class="o">]</span> : <span class="o">==========</span> Server <span class="nv">init</span> <span class="o">==========</span>
</span></span><span class="line"><span class="cl">2023-01-28 04:17:37.625274 <span class="o">[</span>info<span class="o">]</span> : Port:1316, OpenLinger: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">2023-01-28 04:17:37.625281 <span class="o">[</span>info<span class="o">]</span> : Listen Mode: ET, OpenConn Mode: ET
</span></span><span class="line"><span class="cl">2023-01-28 04:17:37.625283 <span class="o">[</span>info<span class="o">]</span> : LogSys level: <span class="m">1</span>
</span></span><span class="line"><span class="cl">2023-01-28 04:17:37.625286 <span class="o">[</span>info<span class="o">]</span> : srcDir: /home/andy/Workplace/cpp_advance/cpp14/WebServer/resources/
</span></span><span class="line"><span class="cl">2023-01-28 04:17:37.625369 <span class="o">[</span>info<span class="o">]</span> : SqlConnPool num: 12, ThreadPool num: <span class="m">6</span>
</span></span><span class="line"><span class="cl">2023-01-28 04:17:37.625376 <span class="o">[</span>info<span class="o">]</span> : <span class="o">==========</span> Server <span class="nv">start</span> <span class="o">==========</span>
</span></span><span class="line"><span class="cl">2023-01-28 04:17:49.682366 <span class="o">[</span>info<span class="o">]</span> : Client<span class="o">[</span>6<span class="o">](</span>172.17.0.1:60549<span class="o">)</span> in, userCount:1
</span></span><span class="line"><span class="cl">2023-01-28 04:17:49.685458 <span class="o">[</span>info<span class="o">]</span> : Client<span class="o">[</span>6<span class="o">]</span> in!
</span></span><span class="line"><span class="cl">2023-01-28 04:17:49.767379 <span class="o">[</span>info<span class="o">]</span> : Client<span class="o">[</span>7<span class="o">](</span>172.17.0.1:64133<span class="o">)</span> in, userCount:2
</span></span><span class="line"><span class="cl">2023-01-28 04:17:49.772650 <span class="o">[</span>info<span class="o">]</span> : Client<span class="o">[</span>7<span class="o">]</span> in!
</span></span><span class="line"><span class="cl">2023-01-28 04:17:49.774038 <span class="o">[</span>info<span class="o">]</span> : Client<span class="o">[</span>8<span class="o">](</span>172.17.0.1:2694<span class="o">)</span> in, userCount:3
</span></span><span class="line"><span class="cl">2023-01-28 04:17:49.775470 <span class="o">[</span>info<span class="o">]</span> : Client<span class="o">[</span>8<span class="o">]</span> in!
</span></span><span class="line"><span class="cl">2023-01-28 04:17:49.777246 <span class="o">[</span>info<span class="o">]</span> : Client<span class="o">[</span>9<span class="o">](</span>172.17.0.1:6278<span class="o">)</span> in, userCount:4
</span></span><span class="line"><span class="cl">2023-01-28 04:17:49.779328 <span class="o">[</span>info<span class="o">]</span> : Client<span class="o">[</span>9<span class="o">]</span> in!
</span></span><span class="line"><span class="cl">2023-01-28 04:17:49.781121 <span class="o">[</span>info<span class="o">]</span> : Client<span class="o">[</span>10<span class="o">](</span>172.17.0.1:7302<span class="o">)</span> in, userCount:5
</span></span><span class="line"><span class="cl">2023-01-28 04:17:49.782755 <span class="o">[</span>info<span class="o">]</span> : Client<span class="o">[</span>10<span class="o">]</span> in!
</span></span><span class="line"><span class="cl">2023-01-28 04:17:49.888415 <span class="o">[</span>info<span class="o">]</span> : Client<span class="o">[</span>11<span class="o">](</span>172.17.0.1:11398<span class="o">)</span> in, userCount:6
</span></span><span class="line"><span class="cl">2023-01-28 04:17:49.890183 <span class="o">[</span>info<span class="o">]</span> : Client<span class="o">[</span>11<span class="o">]</span> in!
</span></span><span class="line"><span class="cl">2023-01-28 04:19:00.082966 <span class="o">[</span>info<span class="o">]</span> : Client<span class="o">[</span>8<span class="o">]</span> quit!
</span></span><span class="line"><span class="cl">2023-01-28 04:19:00.086492 <span class="o">[</span>info<span class="o">]</span> : Client<span class="o">[</span>8<span class="o">](</span>172.17.0.1:2694<span class="o">)</span> quit, UserCount:5
</span></span><span class="line"><span class="cl">2023-01-28 04:19:00.087991 <span class="o">[</span>info<span class="o">]</span> : Client<span class="o">[</span>9<span class="o">]</span> quit!
</span></span><span class="line"><span class="cl">2023-01-28 04:19:00.088420 <span class="o">[</span>info<span class="o">]</span> : Client<span class="o">[</span>9<span class="o">](</span>172.17.0.1:6278<span class="o">)</span> quit, UserCount:4
</span></span><span class="line"><span class="cl">2023-01-28 04:19:00.089962 <span class="o">[</span>info<span class="o">]</span> : Client<span class="o">[</span>11<span class="o">]</span> quit!
</span></span><span class="line"><span class="cl">2023-01-28 04:19:00.091502 <span class="o">[</span>info<span class="o">]</span> : Client<span class="o">[</span>11<span class="o">](</span>172.17.0.1:11398<span class="o">)</span> quit, UserCount:3
</span></span><span class="line"><span class="cl">2023-01-28 04:19:00.092822 <span class="o">[</span>info<span class="o">]</span> : Client<span class="o">[</span>10<span class="o">]</span> quit!
</span></span><span class="line"><span class="cl">2023-01-28 04:19:00.094522 <span class="o">[</span>info<span class="o">]</span> : Client<span class="o">[</span>10<span class="o">](</span>172.17.0.1:7302<span class="o">)</span> quit, UserCount:2
</span></span><span class="line"><span class="cl">2023-01-28 04:19:00.095606 <span class="o">[</span>info<span class="o">]</span> : Client<span class="o">[</span>6<span class="o">]</span> quit!
</span></span><span class="line"><span class="cl">2023-01-28 04:19:00.096684 <span class="o">[</span>info<span class="o">]</span> : Client<span class="o">[</span>6<span class="o">](</span>172.17.0.1:60549<span class="o">)</span> quit, UserCount:1
</span></span><span class="line"><span class="cl">2023-01-28 04:19:00.316124 <span class="o">[</span>info<span class="o">]</span> : Client<span class="o">[</span>7<span class="o">]</span> quit!
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="源码解析-1">源码解析
</h4><p><code>Log</code> 类在被实例化时系统有且最多只有一个 <code>Log</code> 类的对象即单例模式，它是如何实现的呢?</p>
<p>首先会<strong>将 <code>Log</code> 类的构造函数、拷贝构造函数和赋值运算符重载函数私有化</strong>，由此外界就不能直接创建<code>Log</code>类对象，这时我们需要一个<strong>静态 <code>Log</code> 类型的对象，以便系统使用同一的类对象</strong>，而外界想要获取静态 <code>Log</code> 类型的对象，就需要<strong>定义一个静态成员方法，因为只有静态成员方法才能访问静态成员变量</strong>，由此实现 <code>Log</code> 类的单例模式。</p>
<p><code>Log</code> 类及 <code>Instance</code> 函数的定义：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Log</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="n">init</span><span class="p">(</span><span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">path</span> <span class="o">=</span> <span class="s">&#34;./log&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">suffix</span> <span class="o">=</span><span class="s">&#34;.log&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">maxQueueCapacity</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="n">Log</span><span class="o">*</span> <span class="nf">Instance</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="kt">void</span> <span class="nf">FlushLogThread</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">write</span><span class="p">(</span><span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,...);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">flush</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="nf">GetLevel</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">SetLevel</span><span class="p">(</span><span class="kt">int</span> <span class="n">level</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="nf">IsOpen</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">isOpen_</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">Log</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">AppendLogLevelTitle_</span><span class="p">(</span><span class="kt">int</span> <span class="n">level</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">virtual</span> <span class="o">~</span><span class="n">Log</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">AsyncWrite_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">LOG_PATH_LEN</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">LOG_NAME_LEN</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">MAX_LINES</span> <span class="o">=</span> <span class="mi">50000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">path_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">suffix_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">MAX_LINES_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">lineCount_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">toDay_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">isOpen_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="n">Buffer</span> <span class="n">buff_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">level_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">isAsync_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">FILE</span><span class="o">*</span> <span class="n">fp_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">BlockDeque</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&gt;</span> <span class="n">deque_</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">&gt;</span> <span class="n">writeThread_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">mutex</span> <span class="n">mtx_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Log</span><span class="o">*</span> <span class="n">Log</span><span class="o">::</span><span class="n">Instance</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="n">Log</span> <span class="n">inst</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">&amp;</span><span class="n">inst</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>系统中有4种类型的日志，分别是 <code>LOG_DEBUG</code> 、 <code>LOG_INFO</code> 、 <code>LOG_WARN</code> 与 <code>LOG_ERROR</code> ，它们共同使用 <code>LOG_BASE</code>，<strong>以level来区分不同级别的日志</strong>，以实现代码的复用。同时<strong>自己初始设置的日志等级可以控制不同级别的日志是否被记录</strong>，宏定义如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C#" data-lang="C#"><span class="line"><span class="cl"><span class="c1">// 语言设置为 C# 才会有颜色高亮</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define</span> <span class="n">LOG_BASE</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="p">...)</span> \
</span></span><span class="line"><span class="cl">    <span class="k">do</span> <span class="p">{</span>\
</span></span><span class="line"><span class="cl">        <span class="n">Log</span><span class="p">*</span> <span class="n">log</span> <span class="p">=</span> <span class="n">Log</span><span class="p">::</span><span class="n">Instance</span><span class="p">();</span>\
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">log</span><span class="p">-&gt;</span><span class="n">IsOpen</span><span class="p">()</span> <span class="p">&amp;&amp;</span> <span class="n">log</span><span class="p">-&gt;</span><span class="n">GetLevel</span><span class="p">()</span> <span class="p">&lt;=</span> <span class="n">level</span><span class="p">)</span> <span class="p">{</span>\
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="p">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="err">##</span><span class="n">__VA_ARGS__</span><span class="p">);</span> \
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="p">-&gt;</span><span class="n">flush</span><span class="p">();</span>\
</span></span><span class="line"><span class="cl">        <span class="p">}</span>\
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="m">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define</span> <span class="n">LOG_DEBUG</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="p">...)</span> <span class="k">do</span> <span class="p">{</span><span class="n">LOG_BASE</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="err">##</span><span class="n">__VA_ARGS__</span><span class="p">)}</span> <span class="k">while</span><span class="p">(</span><span class="m">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define</span> <span class="n">LOG_INFO</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="p">...)</span> <span class="k">do</span> <span class="p">{</span><span class="n">LOG_BASE</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="err">##</span><span class="n">__VA_ARGS__</span><span class="p">)}</span> <span class="k">while</span><span class="p">(</span><span class="m">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define</span> <span class="n">LOG_WARN</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="p">...)</span> <span class="k">do</span> <span class="p">{</span><span class="n">LOG_BASE</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="err">##</span><span class="n">__VA_ARGS__</span><span class="p">)}</span> <span class="k">while</span><span class="p">(</span><span class="m">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define</span> <span class="n">LOG_ERROR</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="p">...)</span> <span class="k">do</span> <span class="p">{</span><span class="n">LOG_BASE</span><span class="p">(</span><span class="m">3</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="err">##</span><span class="n">__VA_ARGS__</span><span class="p">)}</span> <span class="k">while</span><span class="p">(</span><span class="m">0</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在 <code>webserver.cpp</code> 中，如果开启日志即 <code>openLog = true</code> 时，则会先调用 <code>init()</code> 去<strong>初始化日志信息</strong>，当 <code>maxQueueSize &gt; 0</code> 时则会创建一个阻塞队列与写线程，<strong>值得注意的是日志系统是单线程模式</strong>，因为并不需要较高的并发量，<strong>写线程的回调函数则当阻塞队列不空时持续向 <code>FILE*</code> 类型的指针 <code>fp_</code> 写入字符串</strong>，再使用 <code>fflush(fp_)</code> 刷新至文件中。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Log</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="kt">int</span> <span class="n">level</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">path</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">suffix</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">maxQueueSize</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">isOpen_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">level_</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">maxQueueSize</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">isAsync_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">deque_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">BlockDeque</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&gt;</span> <span class="n">newDeque</span><span class="p">(</span><span class="k">new</span> <span class="n">BlockDeque</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="n">maxQueueSize</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">deque_</span> <span class="o">=</span> <span class="n">move</span><span class="p">(</span><span class="n">newDeque</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">&gt;</span> <span class="n">NewThread</span><span class="p">(</span><span class="k">new</span> <span class="kr">thread</span><span class="p">(</span><span class="n">FlushLogThread</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">writeThread_</span> <span class="o">=</span> <span class="n">move</span><span class="p">(</span><span class="n">NewThread</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">isAsync_</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">lineCount_</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">time_t</span> <span class="n">timer</span> <span class="o">=</span> <span class="n">time</span><span class="p">(</span><span class="k">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="nc">tm</span> <span class="o">*</span><span class="n">sysTime</span> <span class="o">=</span> <span class="n">localtime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="nc">tm</span> <span class="n">t</span> <span class="o">=</span> <span class="o">*</span><span class="n">sysTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">path_</span> <span class="o">=</span> <span class="n">path</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">suffix_</span> <span class="o">=</span> <span class="n">suffix</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">fileName</span><span class="p">[</span><span class="n">LOG_NAME_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">snprintf</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">LOG_NAME_LEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#34;%s/%04d_%02d_%02d%s&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">            <span class="n">path_</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="n">tm_year</span> <span class="o">+</span> <span class="mi">1900</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="n">tm_mon</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="n">tm_mday</span><span class="p">,</span> <span class="n">suffix_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">toDay_</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">tm_mday</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">locker</span><span class="p">(</span><span class="n">mtx_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">buff_</span><span class="p">.</span><span class="n">RetrieveAll</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">fp_</span><span class="p">)</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">            <span class="n">flush</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">fclose</span><span class="p">(</span><span class="n">fp_</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">fp_</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="s">&#34;a&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">fp_</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">mkdir</span><span class="p">(</span><span class="n">path_</span><span class="p">,</span> <span class="mo">0777</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">fp_</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="s">&#34;a&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> 
</span></span><span class="line"><span class="cl">        <span class="n">assert</span><span class="p">(</span><span class="n">fp_</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>当使用 <code>LOG_DEBUG</code> 、 <code>LOG_INFO</code> 、 <code>LOG_WARN</code> 与 <code>LOG_ERROR</code> 时，则会宏替换为 <code>LOG_BASE</code> ， <code>LOG_BASE</code> 继续宏替换至执行代码，然后依据日志开关与等级是否记录，如果记录则会调用 <code>write()</code> 函数，在 <code>write()</code> 函数中会制作日志记录如日志日期、日志行数、日志内容等至 <code>buff_</code> 中，然后添加至阻塞队列中，在 <code>AsyncWrite_()</code> 函数的循环能继续向下执行，向 <code>FILE*</code> 类型的指针 <code>fp_</code> 写入字符串，然后再调用 <code>flush()</code> 函数刷新至日志文件中，这是日志记录的整个过程，可结合上述的具体实现。而 <code>write()</code> 函数可自行查看源代码。</p>
<h2 id="总结与感悟">总结与感悟
</h2><ul>
<li>目前来说，好好完善并思考这个项目就可以达到对于 <code>C++14</code>、<code>Linux</code> 网络编程综合学习与训练的目的了，后面进阶还需要真正参与到工业生产代码中，在实践中认真学习与总结。</li>
<li>这种比较偏底层的网络编程，对于应用层来说已经有了很多成熟的软件库，大多数时候不用修改和优化。</li>
</ul>
<h2 id="源码阅读进阶">源码阅读进阶
</h2><ul>
<li>[[Redis 源码阅读]]</li>
<li><a class="link" href="https://github.com/linyacool/WebServer"  target="_blank" rel="noopener"
    >linyacool/WebServer: A C++ High Performance Web Server</a></li>
<li><a class="link" href="https://github.com/chenshuo/muduo"  target="_blank" rel="noopener"
    >chenshuo/muduo: Event-driven network library for multi-threaded Linux server in C++11</a></li>
</ul>
<h2 id="扩展知识">扩展知识
</h2><ul>
<li><a class="link" href="https://github.com/PlatformLab/NanoLog"  target="_blank" rel="noopener"
    >NanoLog</a>：一个非常高性能的纳秒级c++日志记录系统，它提供了一个简单的类似print的API，在7纳秒的中位数延迟下实现了超过8000万条日志/秒。</li>
<li><a class="link" href="https://github.com/Taywee/args"  target="_blank" rel="noopener"
    >args</a>：C++实现的命令行参数解析器。</li>
</ul>

</section>


    <footer class="article-footer">
    

    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>All Rights Reserved.（所有权利保留。禁止未经授权的复制或再分发。）</span>
    </section>
    </footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI&#43;WdtXRGWt2kTvGFasHpSy3SV"crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG&#43;vnGctmUb0ZY0l8"crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"integrity="sha384-&#43;VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4&#43;/RRE05"crossorigin="anonymous"
                defer
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
        renderMathInElement(document.body, {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ],
            ignoredClasses: ["gist"]
        });})
</script>
    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">相关文章</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/posts/vim-%E7%AE%97%E6%B3%95-%E5%88%B7%E9%A2%98%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/">
        
        
            <div class="article-image">
                <img src="/posts/vim-%E7%AE%97%E6%B3%95-%E5%88%B7%E9%A2%98%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/vim_cover.7d59368db66ac23b301b6313ab84e849_hu12431349409231175071.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Vim 与算法刷题：打造高效开发环境"
                        data-key="Vim-算法-刷题环境配置" 
                        data-hash="md5-fVk2jbZqwjswG2MTq4ToSQ==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Vim 与算法刷题：打造高效开发环境</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/posts/webserverc&#43;&#43;%E7%89%88%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8B%E7%BA%BF%E7%A8%8B%E6%B1%A0/">
        
        
            <div class="article-image">
                <img src="/posts/webserverc&#43;&#43;%E7%89%88%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8B%E7%BA%BF%E7%A8%8B%E6%B1%A0/thread-pool.abc3df4a468918461c0c5e770f2fef00_hu16517212594665624032.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post WebServer（C&#43;&#43;版）代码分析之线程池"
                        data-key="WebServer（C&#43;&#43;版）代码分析之线程池" 
                        data-hash="md5-q8PfSkaJGEYcDF53Dy/vAA==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">WebServer（C&#43;&#43;版）代码分析之线程池</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/posts/gdb%E8%B0%83%E8%AF%95%E5%AD%A6%E4%B9%A0/">
        
        
            <div class="article-image">
                <img src="/posts/gdb%E8%B0%83%E8%AF%95%E5%AD%A6%E4%B9%A0/gdb_cover.3485f3bf63f135b4fbbd04dc8080a7f9_hu12870970506028879207.gif" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post GDB调试秘籍：像高手一样排查问题"
                        data-key="GDB调试学习" 
                        data-hash="md5-NIXzv2PxNbT7vQTcgICn&#43;Q==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">GDB调试秘籍：像高手一样排查问题</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/posts/c&#43;&#43;%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93/">
        
        
            <div class="article-image">
                <img src="/posts/c&#43;&#43;%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93/C&#43;&#43;_cover.a55b357ff9d2e033322598b57d591996_hu15019881840537993967.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post C&#43;&#43;知识点总结"
                        data-key="C&#43;&#43;知识点总结" 
                        data-hash="md5-pVs1f/nS4DMyJZi1fVkZlg==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">C&#43;&#43;知识点总结</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/posts/vue%E5%AD%A6%E4%B9%A0%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/">
        
        
            <div class="article-image">
                <img src="/posts/vue%E5%AD%A6%E4%B9%A0%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/vue_cover.77622c624e1a8f6554f74bb0603a65c3_hu800294363102459429.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Vue入门笔记"
                        data-key="Vue学习入门笔记" 
                        data-hash="md5-d2IsYk4aj2VU90uwYDplww==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Vue入门笔记</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2018 - 
        
        2025 七月流火
    </section>
    
    <section class="powerby">
        使用 <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> 构建 <br />
        主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.27.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

<script
    src="https://cdn.jsdelivr.net/gh/zhixuan2333/gh-blog@v0.1.0/js/ribbon.min.js"
    integrity="sha384-UEK8ZiP3VgFNP8KnKMKDmd4pAUAOJ59Y2Jo3ED2Z5qKQf6HLHovMxq7Beb9CLPUe"
    crossorigin="anonymous"
    size="300"
    alpha="0.6"
    zindex="-1"
    defer
></script>


<script
    src="https://cdn.jsdelivr.net/gh/zhixuan2333/gh-blog@v0.1.0/js/nprogress.min.js"
    integrity="sha384-bHDlAEUFxsRI7JfULv3DTpL2IXbbgn4JHQJibgo5iiXSK6Iu8muwqHANhun74Cqg"
    crossorigin="anonymous"
></script>
<link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/gh/zhixuan2333/gh-blog@v0.1.0/css/nprogress.css"
    integrity="sha384-KJyhr2syt5+4M9Pz5dipCvTrtvOmLk/olWVdfhAp858UCa64Ia5GFpTN7+G4BWpE"
    crossorigin="anonymous"
/>
<script>
    NProgress.start();
    document.addEventListener("readystatechange", () => {
        if (document.readyState === "interactive") NProgress.inc(0.8);
        if (document.readyState === "complete") NProgress.done();
    });
</script>

    </body>
</html>
